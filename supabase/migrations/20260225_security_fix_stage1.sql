-- ============================================================================
-- ğŸ›¡ï¸ [ë³´ì•ˆ íŒ¨ì¹˜ 1ë‹¨ê³„] ê¸°ëŠ¥ ì˜í–¥ ì—†ëŠ” ì¦‰ì‹œ ì ìš© í•­ëª©
-- ì‘ì„±ì¼: 2026-02-25
--
-- ìˆ˜ì • í•­ëª©:
--   A-2: bind_student_auth / unbind_student_auth ì—ì„œ anon ì—­í•  ì‹¤í–‰ ê¶Œí•œ ì œê±°
--        â†’ ë¯¸ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” í•™ìƒ ë°”ì¸ë”© RPC í˜¸ì¶œ ë¶ˆê°€
--        â†’ í•™ìƒ ì•±ì€ í•­ìƒ authenticated ìƒíƒœë¡œ í˜¸ì¶œí•˜ë¯€ë¡œ ê¸°ëŠ¥ ì˜í–¥ ì—†ìŒ
--
--   B-1: vw_students_rls_bypass ë·°ì˜ authenticated ì§ì ‘ SELECT ê¶Œí•œ ì œê±°
--        â†’ ì´ ë·°ëŠ” RLS ì •ì±… ë‚´ë¶€ í‰ê°€ì—ë§Œ ì“°ì´ë¯€ë¡œ ì§ì ‘ ì ‘ê·¼ ë¶ˆí•„ìš”
--        â†’ ì•± ì½”ë“œì—ì„œ ì§ì ‘ ì¡°íšŒí•˜ëŠ” ê³³ ì—†ìŒ, ê¸°ëŠ¥ ì˜í–¥ ì—†ìŒ
-- ============================================================================


-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- [A-2] bind_student_auth / unbind_student_auth anon ê¶Œí•œ ì œê±°
-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

-- ê¸°ì¡´: anon, authenticated ëª¨ë‘ í—ˆìš© â†’ ë¯¸ë¡œê·¸ì¸ ì‚¬ìš©ìë„ í˜¸ì¶œ ê°€ëŠ¥
-- ë³€ê²½: authenticated ë§Œ í—ˆìš©

REVOKE EXECUTE ON FUNCTION public.bind_student_auth(TEXT) FROM anon;
REVOKE EXECUTE ON FUNCTION public.unbind_student_auth() FROM anon;

-- authenticated ê¶Œí•œì€ ìœ ì§€ (í•™ìƒ ì•±ì˜ ì •ìƒ íë¦„)
GRANT EXECUTE ON FUNCTION public.bind_student_auth(TEXT) TO authenticated;
GRANT EXECUTE ON FUNCTION public.unbind_student_auth() TO authenticated;


-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- [B-1] vw_students_rls_bypass ë·° ì§ì ‘ ì ‘ê·¼ ì°¨ë‹¨
--
-- ì´ ë·°ëŠ” RLS ì •ì±… í‰ê°€ë¥¼ ìœ„í•œ ë‚´ë¶€ í—¬í¼ì´ë¯€ë¡œ
-- ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§ì ‘ SELECTí•˜ë©´ ì „ì²´ í•™ìƒ auth_idê°€ ë…¸ì¶œë¨
-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

-- authenticated ì—­í• ì˜ ì§ì ‘ SELECT ê¶Œí•œ ì œê±°
REVOKE SELECT ON public.vw_students_rls_bypass FROM authenticated;
REVOKE SELECT ON public.vw_students_rls_bypass FROM anon;

-- service_role(ì„œë²„)ì€ ìœ ì§€ (ë‚´ë¶€ ì‹œìŠ¤í…œ ì‚¬ìš©)
GRANT SELECT ON public.vw_students_rls_bypass TO service_role;

-- ê¸°ë°˜ í•¨ìˆ˜(fn_get_students_for_rls_check)ì— ëŒ€í•œ ì‹¤í–‰ ê¶Œí•œì€ ìœ ì§€
-- (RLS ì •ì±… í‰ê°€ ì‹œ SECURITY DEFINERë¡œ ì¸í•´ postgres ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ë¨)
GRANT EXECUTE ON FUNCTION public.fn_get_students_for_rls_check() TO authenticated;
GRANT EXECUTE ON FUNCTION public.fn_get_students_for_rls_check() TO service_role;


-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- ìŠ¤í‚¤ë§ˆ ìºì‹œ ê°±ì‹ 
-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
NOTIFY pgrst, 'reload schema';


-- ====================================================================
-- âœ… ì™„ë£Œ! 
--
-- ê²€ì¦ ë°©ë²•:
--   [A-2 ê²€ì¦] ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ë¡œê·¸ì•„ì›ƒ ìƒíƒœë¡œ:
--     await supabase.rpc('bind_student_auth', { p_student_code: 'TEST' })
--     â†’ 42501 ê¶Œí•œ ì˜¤ë¥˜ ë°œìƒ í™•ì¸ (ì´ì „ì—ëŠ” í˜¸ì¶œ ê°€ëŠ¥)
--
--   [B-1 ê²€ì¦] í•™ìƒ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ í›„ ì½˜ì†”ì—ì„œ:
--     const { data, error } = await supabase.from('vw_students_rls_bypass').select('*')
--     â†’ 42501 ê¶Œí•œ ì˜¤ë¥˜ ë˜ëŠ” ë¹ˆ ê²°ê³¼ í™•ì¸ (ì´ì „ì—ëŠ” ì „ì²´ í•™ìƒ ëª©ë¡ ë°˜í™˜)
--
--   [ì •ìƒ ê¸°ëŠ¥ í™•ì¸]
--     - í•™ìƒ ì½”ë“œë¡œ ë¡œê·¸ì¸ â†’ ì„±ê³µ í™•ì¸
--     - ê°™ì€ í•™ê¸‰ í•™ìƒ ê²Œì‹œê¸€ ì¡°íšŒ â†’ ì •ìƒ í™•ì¸
--     - êµì‚¬ í•™ê¸‰ ê´€ë¦¬ ê¸°ëŠ¥ â†’ ì •ìƒ í™•ì¸
-- ====================================================================
